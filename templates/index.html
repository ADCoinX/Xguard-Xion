<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XGuard-Xion Dashboard</title>

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --bg-1:#0a0713; --bg-2:#1b0f2e; --grad-1:#6a00ff; --grad-2:#ff3e8a;
      --accent:#00ffa6; --accent-2:#ffc857; --surface:#120a1f; --border:#9237ff33;
      --text:#f6f6f9; --muted:#c9c9d6; --shadow: 0 20px 60px rgba(0,0,0,.45), 0 2px 0 rgba(255,255,255,.04) inset; --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Poppins',sans-serif; color:var(--text);
      background:
        radial-gradient(1200px 700px at 80% -10%, #331050 20%, transparent 60%),
        radial-gradient(900px 600px at -10% 10%, #2a0b45 20%, transparent 55%),
        linear-gradient(145deg, var(--bg-1), var(--bg-2));
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{width:100%; max-width:1024px;}
    .card{background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:28px;}
    .brand{display:flex; align-items:center; gap:14px; margin-bottom:22px;}
    .brand img{width:120px; height:120px; border-radius:20px; background:#26133e; object-fit:contain;}
    .brand h1{font-size:clamp(22px, 2.6vw, 32px); margin:0;
      background: linear-gradient(90deg, var(--grad-1), var(--grad-2));
      -webkit-background-clip:text; background-clip:text; color:transparent; font-weight:700;}
    .sub{margin:4px 0 0 0; color:var(--muted); font-size:.95rem; font-weight:500;}

    .panel{display:grid; gap:18px; margin-top:18px;}
    .input-row{display:flex; gap:10px;}
    .input{flex:1; min-width:0; background:linear-gradient(180deg, #1c1230, #130b23);
      border:1px solid #8946ff44; color:var(--text); padding:14px 16px; border-radius:14px; font-size:16px; outline:none;}

    .btns{display:grid; grid-template-columns: repeat(2,1fr); gap:10px;}
    .btn{border:0; cursor:pointer; text-align:center; padding:14px 16px; border-radius:14px; font-weight:700; font-size:15px; box-shadow:0 10px 26px rgba(0,0,0,.35);}
    .btn-primary{background: linear-gradient(180deg,#00ffbf,#00d18f); color:#061013;}
    .btn-warn{background: linear-gradient(180deg,#ffd36b,#ffb642); color:#2b1900;}
    .btn-ghost{background:linear-gradient(180deg,#26133e,#1b0f2e); color:#e9defa; border:1px solid #ffffff1f;}
    .btn-disabled{background: linear-gradient(180deg,#3a2a57,#2a1d43); color:#a693c4; border:1px dashed #9c7fe033; cursor:not-allowed;}
    .pill{font-size:.72rem; padding:4px 8px; border-radius:999px; background:#ff3e8a; color:white;}

    .section{margin-top:20px; border:1px solid #8b46ff22; border-radius:14px; padding:18px;}
    .section h2{margin:0 0 10px 0; font-size:18px; font-weight:700; color:#ffd8f0;}
    .kv{display:grid; grid-template-columns:160px 1fr; gap:10px; margin:8px 0; font-size:14.5px;}
    .kv .k{color:#cdb8ff}
    .mono{font-family:monospace}

    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{padding:12px 10px; border-bottom:1px solid #ffffff12}
    th{color:#d8baff; background:#170d2a}

    .footer{margin-top:18px; color:#a39cb8; font-size:.8rem; text-align:center}

    @media(max-width:840px){.btns{grid-template-columns:1fr 1fr;}.kv{grid-template-columns:1fr;}}
    @media(max-width:520px){.input-row{flex-direction:column;}.btns{grid-template-columns:1fr;}.card{padding:22px;}}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">

      <!-- Brand -->
      <header class="brand">
        <img src="/static/Xguard-logo.png" alt="XGuard Logo"
             onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAI0lEQVR4nO3BMQEAAADCoPVPbQsvoAAAAAAAAAAAAPgJqgAAAV8n9LwAAAAASUVORK5CYII=';">
        <div>
          <h1>XGuard-Xion</h1>
          <p class="sub">Validator + Risk Score + ISO 20022 Export</p>
        </div>
      </header>

      <!-- Auth Panel (Google/Apple) -->
      <section class="panel" id="authPanel">
        <div class="input-row" style="gap:12px; flex-wrap:wrap">
          <button id="loginGoogle" class="btn btn-primary">Sign in with Google</button>
          <button id="loginApple"  class="btn btn-primary">Sign in with Apple</button>
          <button id="logout" class="btn btn-ghost" style="display:none">Log out</button>
        </div>
        <div id="acct" class="section" style="display:none">
          <h2>Account</h2>
          <div class="kv">
            <div class="k">Xion Address</div><div class="v mono" id="addr">-</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px">
            <button id="validateBtn" class="btn btn-warn">Validate My Account</button>
            <button id="copyBtn" class="btn btn-ghost">Copy Address</button>
          </div>
          <p style="color:#c9c9d6; font-size:.9rem; margin-top:8px">
            *Alamat diambil dari sesi login (account abstraction). Tiada input manual diperlukan.
          </p>
        </div>

        <!-- Manual form fallback -->
        <form method="post" action="/validate" class="input-row" id="manualForm" style="display:none">
          <input class="input mono" name="wallet_addr" placeholder="Enter Xion wallet (xion1â€¦)" required>
          <button type="submit" class="btn btn-primary">Validate Wallet</button>
        </form>

        <div class="btns">
          <button class="btn btn-disabled" disabled>
            List RWA Assets <span class="pill">IN DEV</span>
          </button>
          <a class="btn btn-warn" href="/iso/pain001.xml" download>Download ISO XML</a>
          <a class="btn btn-ghost" href="/metrics">Show Metrics</a>
          <a class="btn btn-ghost" href="/docs" target="_blank">API Docs</a>
        </div>
      </section>

      <!-- Results -->
      {% if result %}
      <section class="section">
        <h2>Result</h2>
        <div class="kv"><div class="k">Status</div><div class="v">{{ result }}</div></div>
        {% if score is not none %}
        <div class="kv"><div class="k">Risk Score</div><div class="v"><b style="color:var(--accent)">{{ score }}</b></div></div>
        {% endif %}
        {% if wallet %}
        <div class="kv"><div class="k">Address</div><div class="v mono">{{ wallet.address }}</div></div>
        <div class="kv"><div class="k">Balance</div><div class="v">{{ wallet.balance }}</div></div>
        <div class="kv"><div class="k">Tx Count</div><div class="v">{{ wallet.tx_count }}</div></div>
        <div class="kv"><div class="k">Failed Tx</div><div class="v">{{ wallet.failed_txs }}</div></div>
        <div class="kv"><div class="k">Anomaly</div><div class="v">{{ wallet.anomaly }}</div></div>
        {% endif %}
      </section>
      {% endif %}

      {% if metrics %}
      <section class="section">
        <h2>Metrics & User Log</h2>
        <div style="overflow:auto">
          <table>
            <thead>
              <tr><th>Timestamp</th><th>Address</th><th>Duration</th><th>Score</th><th>Status</th></tr>
            </thead>
            <tbody>
              {% for m in metrics %}
              <tr>
                <td class="mono">{{ m.timestamp }}</td>
                <td class="mono">{{ m.address }}</td>
                <td>{{ m.duration }}</td>
                <td>{{ m.score }}</td>
                <td>{{ m.status }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
      {% endif %}

      <p class="footer">
        Disclaimer: This dashboard is for informational purposes only. All data is simulated and not financial advice. Use at your own risk.<br/>
        <span style="color:var(--accent-2)">Powered by ADCX LAB</span>
      </p>
    </section>
  </main>

  <!-- SDKs -->
  <script src="https://cdn.jsdelivr.net/npm/@web3auth/modal@9/dist/index.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/elliptic@6.5.4/dist/elliptic.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hash.js@1.1.7/dist/hash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bech32@2.0.0/index.min.js"></script>

  <script>
    const WEB3AUTH_CLIENT_ID = "PASTE_YOUR_WEB3AUTH_CLIENT_ID_HERE";
    const BECH32_PREFIX = "xion";

    function toast(msg, danger=false){
      const t = document.createElement("div");
      t.textContent = msg;
      t.style.cssText = `
        position:fixed; left:50%; top:18px; transform:translateX(-50%);
        background:${danger? "#3f1a23":"#12281f"}; color:${danger? "#ffb7aa":"#b7ffe7"};
        border:1px solid ${danger? "#ff725e55":"#00ffa655"};
        padding:10px 14px; border-radius:12px; font-weight:600; z-index:9999;
        box-shadow:0 10px 30px rgba(0,0,0,.45);
      `;
      document.body.appendChild(t); setTimeout(()=> t.remove(), 2000);
    }

    function privKeyToXionAddress(hexPriv){
      const ec = new elliptic.ec("secp256k1");
      const key = ec.keyFromPrivate(hexPriv, "hex");
      const pub = key.getPublic(true, "array");
      const sha = hashjs.sha256().update(pub).digest();
      const rip = hashjs.ripemd160().update(sha).digest();
      const words = bech32.bech32.toWords(Uint8Array.from(rip));
      return bech32.bech32.encode(BECH32_PREFIX, words);
    }

    let web3auth = null;
    let detectedAddr = null;

    async function initWeb3Auth(){
      if (!window.Web3Auth) {
        document.getElementById("manualForm").style.display = "flex";
        return;
      }
      web3auth = new window.Web3AuthModal.Web3Auth({
        clientId: WEB3AUTH_CLIENT_ID,
        web3AuthNetwork: "sapphire_devnet",
        chainConfig: {
          chainNamespace: "other",
          chainId: "xion-testnet-1",
          rpcTarget: "https://api.xion-testnet-1.burnt.dev",
          displayName: "Xion Testnet",
          ticker: "UXION",
          tickerName: "UXION",
        },
        uiConfig: { appName: "XGuard-Xion", mode: "dark" },
      });
      await web3auth.initModal();
    }

    function showAccount(addr){
      document.getElementById("addr").textContent = addr;
      document.getElementById("acct").style.display = "block";
      document.getElementById("logout").style.display = "inline-block";
    }

    async function doLogin(provider){
      if (!web3auth){ toast("SDK not ready", true); return; }
      try{
        const providerConfig = provider === "google" ? { loginProvider:"google" } : { loginProvider:"apple" };
        await web3auth.connectTo(window.Web3AuthModal.WALLET_ADAPTERS.OPENLOGIN, providerConfig);

        const privKey = await web3auth?.provider?.request({ method: "private_key" });
        if (!privKey){ throw new Error("Private key not available"); }

        detectedAddr = privKeyToXionAddress(privKey);
        showAccount(detectedAddr);
        toast("Login success");
      }catch(e){
        toast("Login failed: " + (e?.message || e), true);
      }
    }

    async function doLogout(){
      try{ await web3auth.logout(); }catch(_){}
      detectedAddr = null;
      document.getElementById("acct").style.display = "none";
      document.getElementById("logout").style.display = "none";
      toast("Logged out");
    }

    function postValidate(addr){
      if (!addr){ toast("No address detected", true); return; }
      const form = document.createElement("form");
      form.method = "POST"; form.action = "/validate";
      const inp = document.createElement("input");
      inp.type = "hidden"; inp.name = "wallet_addr"; inp.value = addr;
      form.appendChild(inp); document.body.appendChild(form); form.submit();
    }

    function copy(text){
      navigator.clipboard.writeText(text).then(()=> toast("Copied"));
    }

    window.addEventListener("DOMContentLoaded", async () => {
      await initWeb3Auth();
      if (!web3auth){ document.getElementById("manualForm").style.display = "flex"; return; }

      document.getElementById("loginGoogle").onclick = ()=> doLogin("google");
      document.getElementById("loginApple").onclick  = ()=> doLogin("apple");
      document.getElementById("logout").onclick      = ()=> doLogout();
      document.getElementById("validateBtn").onclick = ()=> postValidate(detectedAddr);
      document.getElementById("copyBtn").onclick     = ()=> copy(detectedAddr || "");
    });
  </script>
</body>
</html>
